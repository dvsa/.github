name: Terraform Action

inputs: 
  action: 
    description: 'Comma-separated list of terraform actions to run e.g plan | init,plan,apply'
    required: true
    type: string
  project: 
    description: 'Terraform project'
    required: true
    type: string
  environment: 
    description: 'Terraform environment'
    required: true
    type: string
  component: 
    description: 'Terraform component'
    required: true
    type: string
  group: 
    description: 'Terraform group'
    required: true
    type: string
  bucket-prefix: 
    description: 'AWS Terraform bucket used for TF state'
    required: true
    type: string
  region:
    description: 'AWS region'
    required: true
    type: string
  terraform_version:
    type: number
    default: '1.3.7'
    description: Terraform Version to install on runner 
  terraform_args:
    type: string
    default: ''
    description: Additional Terraform arguments 

runs:
  using: 'composite'
  steps: 
    - uses: hashicorp/setup-terraform@v3.0.0
      with:
        terraform_version:  ${{ inputs.terraform_version }}      
        terraform_wrapper: false

    - name: Terraform init and plan
      id: plan
      run: |
        actionList=($(echo ${{ inputs.action }} | tr "," " "))
        for action in "${actionList[@]}"; do
          ./bin/terraform.sh --action ${action} \
            --project ${{ inputs.project }} --environment ${{ inputs.environment }} \
            --component ${{ inputs.component }} --group ${{ inputs.group }} \
            --region ${{ inputs.region }} --bucket-prefix ${{ inputs.bucket-prefix }}
        done
      shell: bash
