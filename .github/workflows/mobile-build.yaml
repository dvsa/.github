name: Build Mobile
on:
  workflow_call:
    inputs:
      builder:
        required: true
        type: string
        description: "The Self-Hosted Runner's label for this Job"
      
      branch_name:
        required: true
        type: string
    
      environment:
        required: true
        type: string
      
      node_version:
        required: false
        type: string
        default: '14'

    secrets:
      AWS_ROLE: 
        required: true
      NPMRC: 
        required: true
      DOTENV: 
        required: true
      VERSION_BUCKET:
        required: true
            

jobs:
  build:
    name: "Build ${{ inputs.environment }} Mobile Artefacts"
    runs-on: ${{ inputs.builder }}
    steps:
      - uses: actions/checkout@v3
        with: 
          ref: ${{ inputs.branch_name }}

      - uses: actions/setup-node@v3
        with: 
          node-version: ${{ inputs.node_version }}
      
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: eu-west-1
          role-session-name: GHAMobileBuild

      - name: "üìÇ Set Configuration Files"
        run: |
          echo ${{ secrets.NPMRC }} | base64 --decode > .npmrc
          echo ${{ secrets.DOTENV }} | base64 --decode > .env
          aws s3 cp ${{ secrets.VERSION_BUCKET }}/github-actions/latest-develop.txt latest-version.txt
          echo "CURRENT_VERSION=$(cat latest-version.txt)" >> $GITHUB_ENV
          echo "BUILD_VERSION=${{ github.run_id }}" >> $GITHUB_ENV
          version=$(bash .github/scripts/bump.sh ${{ env.CURRENT_VERSION }} 1)
          echo NEXT_VERSION=$(echo $version) >> $GITHUB_ENV
          echo $version > latest-version.txt
          aws s3 cp latest-version.txt ${{ secrets.CVS_VERSIONING }}/github-actions/latest-develop.txt
      
      - name: "‚öôÔ∏è Install Dependencies"
        run: |
          npm install -g @ionic/cli qrcode-terminal @capacitor/core @capacitor/cli
          set +x; . ./.env; set -x; npm install --legacy-peer-deps
      
      - name: "‚öôÔ∏è Check Environment"
        run: env