name: Build Mobile
on:
  workflow_call:
    inputs:
      builder:
        required: true
        type: string
        description: "The Self-Hosted Runner's label for this Job"
      branch_name:
        required: true
        type: string
      environment:
        required: true
        type: string
      node_version:
        required: false
        type: string
        default: '14'
    
    secrets:
      AWS_ROLE:
        required: true
      NPMRC:
        required: true
      DOTENV:
        required: true
      VERSION_BUCKET:
        required: true
      APPLE_DEVELOPER_EMAIL:
        required: true
      APPLE_DEVELOPER_PASSWORD:
        required: true
      MACHINE_PASSWORD:
        required: true
      ARTEFACT_S3:
        required: true


permissions:
  id-token: write
  contents: read

jobs:
  build:
    environment: ${{ inputs.environment }}
    name: "Build ${{ inputs.environment }} Mobile Artefacts"
    runs-on: ${{ inputs.builder }}
    steps:
      - uses: actions/checkout@v3
        with: 
          ref: ${{ inputs.branch_name }}

      - uses: actions/setup-node@v3
        with: 
          node-version: ${{ inputs.node_version }}
      
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          aws-region: eu-west-1
          role-session-name: GHAMobileBuild

      - name: "üìÇ Set Configuration Files"
        shell: bash
        run: |
          echo ${{ secrets.NPMRC }} | base64 --decode > .npmrc
          echo ${{ secrets.DOTENV }} | base64 --decode > .env
          aws s3 cp ${{ secrets.VERSION_BUCKET }}/github-actions/latest-develop.txt latest-version.txt
          echo "0.1827.0" > latest-version.txt
          echo "CURRENT_VERSION=$(cat latest-version.txt)" >> $GITHUB_ENV
          current_vers=$(cat latest-version.txt)
          echo "BUILD_VERSION=${{ github.run_id }}" >> $GITHUB_ENV
          version=$(bash .github/scripts/bump.sh $current_vers 1)
          echo NEXT_VERSION=$(echo $version) >> $GITHUB_ENV
          echo $version > latest-version.txt
          aws s3 cp latest-version.txt ${{ secrets.VERSION_BUCKET }}/github-actions/latest-develop.txt
      
      - name: "‚öôÔ∏è Install Dependencies"
        run: |
          npm install -g @ionic/cli qrcode-terminal @capacitor/core @capacitor/cli
          set +x; . ./.env; set -x; npm install --legacy-peer-deps

      - name: "üì± Run Fastlane"
        env: 
          EMAIL: ${{ secrets.APPLE_DEVELOPER_EMAIL }}
          MATCH_PASSWORD: ${{ secrets.APPLE_DEVELOPER_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.MACHINE_PASSWORD }}
          ARETFACT_S3: ${{ secrets.ARTEFACT_S3 }}
          BRANCH: develop
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          npm run build-ios -- --no-open
          bundle install --jobs $(sysctl -n hw.physicalcpu) && fastlane build